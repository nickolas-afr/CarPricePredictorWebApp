@page "/predict"
@inject IPredictionService PredictionService
@inject ICarDataService CarDataService
@inject IMarketComparisonService MarketComparisonService
@inject IVinDecoderService VinDecoderService
@inject IDealScoreService DealScoreService
@using CarPricePredictor.Web.Data
@using CarPricePredictor.Web.Models

<PageTitle>Car Price Prediction</PageTitle>

<h1>Car Price Prediction</h1>

<!-- VIN Decoder Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">üîç Quick VIN Decoder</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">Enter a 17-character VIN to auto-populate car details</p>
        <div class="row g-2">
            <div class="col-md-8">
                <input type="text" class="form-control" @bind="vinNumber" placeholder="Enter VIN (17 characters)" maxlength="17" />
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100" @onclick="DecodeVin" disabled="@isDecodingVin">
                    @if (isDecodingVin)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Decoding...</span>
                    }
                    else
                    {
                        <span>Decode VIN</span>
                    }
                </button>
            </div>
        </div>
        @if (!string.IsNullOrEmpty(vinMessage))
        {
            <div class="alert @(vinSuccess ? "alert-success" : "alert-danger") mt-2">
                @vinMessage
            </div>
        }
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <EditForm Model="@carInput" OnValidSubmit="@HandlePredict">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label for="make" class="form-label">Brand (Make) <span class="text-danger">*</span></label>
                <InputSelect id="make" class="form-control" @bind-Value="carInput.Make" @onchange="OnBrandChanged">
                    <option value="">-- Select Brand --</option>
                    @foreach (var brand in brandModels.Keys
                        .OrderBy(b => b.Equals("Others", StringComparison.OrdinalIgnoreCase) ? 1 : 0)
                        .ThenBy(b => b))
                    {
                        <option value="@brand">@brand</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => carInput.Make)" />
            </div>

            <div class="mb-3">
                <label for="model" class="form-label">Model <span class="text-danger">*</span></label>
                <InputSelect id="model" class="form-control" @bind-Value="carInput.Model" disabled="@(string.IsNullOrEmpty(carInput.Make))">
                    <option value="">-- Select Model --</option>
                    @if (!string.IsNullOrEmpty(carInput.Make) && brandModels.ContainsKey(carInput.Make))
                    {
                        @foreach (var model in brandModels[carInput.Make])
                        {
                            <option value="@model">@model</option>
                        }
                    }
                </InputSelect>
                <ValidationMessage For="@(() => carInput.Model)" />
            </div>

            <div class="mb-3">
                <label for="year" class="form-label">Production Year: <strong>@carInput.Year</strong> <span class="text-danger">*</span></label>
                <div class="row g-2 align-items-center">
                    <div class="col-9">
                        <input type="range" id="year" class="form-range" min="1990" max="@DateTime.Now.Year" step="1" @bind="carInput.Year" @bind:event="oninput" />
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">1990</small>
                            <small class="text-muted">@DateTime.Now.Year</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <InputNumber id="yearInput" class="form-control" @bind-Value="carInput.Year" min="1990" max="@DateTime.Now.Year" />
                    </div>
                </div>
                <ValidationMessage For="@(() => carInput.Year)" />
            </div>

            <div class="mb-3">
                <label for="mileage" class="form-label">Mileage: <strong>@carInput.Mileage.ToString("N0") km</strong> <span class="text-danger">*</span></label>
                <div class="row g-2 align-items-center">
                    <div class="col-9">
                        <input type="range" id="mileage" class="form-range" min="0" max="500000" step="5000" @bind="carInput.Mileage" @bind:event="oninput" />
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">0 km</small>
                            <small class="text-muted">500,000 km</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <InputNumber id="mileageInput" class="form-control" @bind-Value="carInput.Mileage" min="0" max="500000" />
                    </div>
                </div>
                <ValidationMessage For="@(() => carInput.Mileage)" />
            </div>

            <div class="mb-3">
                <label for="fuel" class="form-label">Fuel Type</label>
                <InputSelect id="fuel" class="form-control" @bind-Value="carInput.Fuel">
                    <option value="">-- Select Fuel Type --</option>
                    <option value="Petrol">Petrol (Gasoline)</option>
                    <option value="Diesel">Diesel</option>
                    <option value="Electric">Electric</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="CNG">CNG</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label for="gear" class="form-label">Transmission</label>
                <InputSelect id="gear" class="form-control" @bind-Value="carInput.Gear">
                    <option value="">-- Select Transmission --</option>
                    <option value="Manual">Manual</option>
                    <option value="Automatic">Automatic</option>
                    <option value="Semi-automatic">Semi-automatic</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label for="hp" class="form-label">Horsepower: <strong>@carInput.Hp HP</strong></label>
                <div class="row g-2 align-items-center">
                    <div class="col-9">
                        <input type="range" id="hp" class="form-range" min="50" max="500" step="5" @bind="carInput.Hp" @bind:event="oninput" />
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">50 HP</small>
                            <small class="text-muted">500 HP</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <InputNumber id="hpInput" class="form-control" @bind-Value="carInput.Hp" min="50" max="1000" />
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="offerType" class="form-label">Offer Type <span class="text-danger">*</span></label>
                <InputSelect id="offerType" class="form-control" @bind-Value="carInput.OfferType">
                    <option value="-1">-- Select Offer Type --</option>
                    <option value="0">Used</option>
                    <option value="1">New</option>
                </InputSelect>
                <ValidationMessage For="@(() => carInput.OfferType)" />
            </div>

            <div class="mb-3">
                <label for="price" class="form-label">Asking Price (‚Ç¨) <span class="text-danger">*</span></label>
                <InputNumber id="price" class="form-control" @bind-Value="carInput.Price" />
                <ValidationMessage For="@(() => carInput.Price)" />
            </div>

            <button type="submit" class="btn btn-primary" disabled="@isPredicting">
                @if (isPredicting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Analyzing...</span>
                }
                else
                {
                    <span>Check Price</span>
                }
            </button>
        </EditForm>
    </div>

    <div class="col-md-6">
        @if (showResult && result != null)
        {
            <div class="card">
                <div class="card-header @GetStatusClass(result.PriceStatus)">
                    <h3>@result.PriceStatus</h3>
                </div>
                <div class="card-body">
                    @if (result.PriceStatus == "Model Not Available")
                    {
                        <div class="alert alert-warning">
                            <p><strong>ML Model not found!</strong></p>
                            <p>Please train the model first using the CarPricePredictor.ML console application and place the model file at:</p>
                            <code>wwwroot/MLModels/CarPriceModel.zip</code>
                        </div>
                    }
                    else
                    {
                        <!-- Deal Score Gauge -->
                        @if (dealScore != null)
                        {
                            <DealScoreGauge @ref="dealScoreGauge" DealScore="dealScore" />
                        }

                        <h4>Price Analysis</h4>
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>Your Price:</th>
                                    <td>‚Ç¨@carInput.Price.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <th>Predicted Price:</th>
                                    <td>‚Ç¨@result.PredictedPrice.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <th>Difference:</th>
                                    <td>‚Ç¨@result.Difference.ToString("N2") (@result.DifferencePercentage.ToString("N1")%)</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Market Comparison -->
                        @if (marketComparison != null && marketComparison.HasData)
                        {
                            <h4>üìä Market Comparison</h4>
                            <div class="alert alert-info">
                                <strong>Average Market Price:</strong> ‚Ç¨@marketComparison.AverageMarketPrice.ToString("N2")
                                @if (marketComparison.PriceComparisonPercentage != 0)
                                {
                                    <br />
                                    <span>Your price is <strong>@Math.Abs(marketComparison.PriceComparisonPercentage).ToString("N1")%</strong> 
                                        @(marketComparison.PriceComparisonPercentage > 0 ? "above" : "below") the market average</span>
                                }
                            </div>
                            
                            @if (marketComparison.Listings.Any())
                            {
                                <h5>Similar Listings:</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Source</th>
                                                <th>Year</th>
                                                <th>Mileage</th>
                                                <th>Price</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var listing in marketComparison.Listings)
                                            {
                                                <tr>
                                                    <td>@listing.Source</td>
                                                    <td>@listing.Year</td>
                                                    <td>@listing.Mileage.ToString("N0") km</td>
                                                    <td>‚Ç¨@listing.Price.ToString("N2")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        }
                        else if (!string.IsNullOrEmpty(marketComparison?.ErrorMessage))
                        {
                            <div class="alert alert-warning">
                                @marketComparison.ErrorMessage
                            </div>
                        }

                        <h4>Typical Price Range</h4>
                        <div class="alert alert-info">
                            <p>
                                For this car, similar listings typically range from:
                                <br />
                                <strong>‚Ç¨@result.MinPrice.ToString("N2")</strong> to <strong>‚Ç¨@result.MaxPrice.ToString("N2")</strong>
                            </p>
                        </div>

                        @if (result.PriceStatus == "Good Price")
                        {
                            <div class="alert alert-success">
                                <strong>‚úì This is a fair price!</strong> The asking price is within the typical market range.
                            </div>
                        }
                        else if (result.PriceStatus == "Too High")
                        {
                            <div class="alert alert-danger">
                                <strong>‚ö† Price is too high!</strong> The asking price is above typical market value. Consider negotiating.
                            </div>
                        }
                        else if (result.PriceStatus == "Too Low")
                        {
                            <div class="alert alert-warning">
                                <strong>‚ö† Price seems low!</strong> This might be a great deal, but verify the car's condition carefully.
                            </div>
                        }
                    }
                </div>
            </div>
        }
        else if (isPredicting)
        {
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Analyzing car price and fetching market data...</span>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <p>Fill in the form and click "Check Price" to get a prediction.</p>
            </div>
        }
    </div>
</div>

@code {
    private CarInputModel carInput = new CarInputModel();
    private PredictionResultModel? result;
    private MarketComparisonResult? marketComparison;
    private DealScore? dealScore;
    private DealScoreGauge? dealScoreGauge;
    private bool showResult = false;
    private bool isPredicting = false;
    private bool isDecodingVin = false;
    private Dictionary<string, List<string>> brandModels = new();
    
    // VIN decoder fields
    private string vinNumber = string.Empty;
    private string vinMessage = string.Empty;
    private bool vinSuccess = false;

    protected override void OnInitialized()
    {
        // Load brand/model data from service (which may load from dataset or fallback to hardcoded)
        brandModels = CarDataService.GetBrandModels();
        
        // Set default values for sliders to avoid validation errors
        carInput.Year = 1990; // Default to 5 years old
        carInput.Mileage = 0;
        carInput.Hp = 50;
        carInput.OfferType = -1;
    }

    private async Task DecodeVin()
    {
        vinMessage = string.Empty;
        vinSuccess = false;

        if (string.IsNullOrWhiteSpace(vinNumber))
        {
            vinMessage = "Please enter a VIN number.";
            return;
        }

        if (!VinDecoderService.IsValidVin(vinNumber))
        {
            vinMessage = "Invalid VIN format. VIN must be 17 characters and cannot contain I, O, or Q.";
            return;
        }

        isDecodingVin = true;
        StateHasChanged();

        try
        {
            var vinResult = await VinDecoderService.DecodeVinAsync(vinNumber);

            if (vinResult.Success)
            {
                // Auto-populate form fields
                carInput.Make = vinResult.Make;
                carInput.Model = vinResult.Model;
                carInput.Year = vinResult.Year;
                
                // Map fuel type
                if (!string.IsNullOrEmpty(vinResult.FuelType))
                {
                    carInput.Fuel = vinResult.FuelType;
                }
                
                // Map transmission
                if (!string.IsNullOrEmpty(vinResult.Transmission))
                {
                    carInput.Gear = vinResult.Transmission;
                }

                vinMessage = "‚úì VIN decoded successfully! Form fields have been populated.";
                vinSuccess = true;
            }
            else
            {
                vinMessage = vinResult.ErrorMessage;
                vinSuccess = false;
            }
        }
        catch (Exception ex)
        {
            vinMessage = $"Error decoding VIN: {ex.Message}";
            vinSuccess = false;
        }
        finally
        {
            isDecodingVin = false;
            StateHasChanged();
        }
    }

    private void OnBrandChanged(ChangeEventArgs e)
    {
        carInput.Make = e.Value?.ToString() ?? string.Empty;
        carInput.Model = string.Empty; // Reset model when brand changes
    }

    private async Task HandlePredict()
    {
        isPredicting = true;
        showResult = false;
        StateHasChanged();

        try
        {
            // Get price prediction
            result = PredictionService.PredictPrice(carInput);
            
            // Get market comparison data
            marketComparison = await MarketComparisonService.GetMarketComparisonAsync(carInput);
            
            // Calculate deal score
            var marketAvg = marketComparison?.HasData == true ? marketComparison.AverageMarketPrice : (float?)null;
            dealScore = DealScoreService.CalculateDealScore(result.PredictedPrice, carInput.Price, marketAvg);
            
            showResult = true;
        }
        catch (Exception)
        {
            // Handle error gracefully
            result = new PredictionResultModel
            {
                PriceStatus = "Error",
                PredictedPrice = 0
            };
            showResult = true;
        }
        finally
        {
            isPredicting = false;
            StateHasChanged();
        }
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Good Price" => "bg-success text-white",
            "Too High" => "bg-danger text-white",
            "Too Low" => "bg-warning",
            _ => "bg-secondary text-white"
        };
    }
}
